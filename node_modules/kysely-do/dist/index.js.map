{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import {\n  CompiledQuery,\n  Kysely,\n  SqliteAdapter,\n  SqliteIntrospector,\n  SqliteQueryCompiler,\n  type DatabaseConnection,\n  type DatabaseIntrospector,\n  type Dialect,\n  type Driver,\n  type QueryCompiler,\n  type QueryResult,\n} from 'kysely'\n\n/**\n * Config for the D1 dialect. Pass your D1 instance to this object that you bound in `wrangler.toml`.\n */\nexport interface DODialectConfig {\n  ctx: DurableObjectState\n}\n\n/**\n * DO dialect that adds support for [Cloudflare Durable Objects][0] in [Kysely][1].\n * The constructor takes the instance of your DO database that you bound in `wrangler.toml`.\n *\n * ```typescript\n * new DODialect({\n *   database: env.DB,\n * })\n * ```\n *\n * [0]: https://developers.cloudflare.com/durable-objects/\n * [1]: https://github.com/koskimas/kysely\n */\nexport class DODialect implements Dialect {\n  #config: DODialectConfig\n\n  constructor(config: DODialectConfig) {\n    this.#config = config\n  }\n\n  createAdapter() {\n    return new SqliteAdapter()\n  }\n\n  createDriver(): Driver {\n    return new DODriver(this.#config)\n  }\n\n  createQueryCompiler(): QueryCompiler {\n    return new SqliteQueryCompiler()\n  }\n\n  createIntrospector(db: Kysely<any>): DatabaseIntrospector {\n    return new SqliteIntrospector(db)\n  }\n}\n\nclass DODriver implements Driver {\n  #config: DODialectConfig\n\n  constructor(config: DODialectConfig) {\n    this.#config = config\n  }\n\n  async init(): Promise<void> {}\n\n  async acquireConnection(): Promise<DatabaseConnection> {\n    return new DOConnection(this.#config)\n  }\n\n  async beginTransaction(conn: DOConnection): Promise<void> {\n    return await conn.beginTransaction()\n  }\n\n  async commitTransaction(conn: DOConnection): Promise<void> {\n    return await conn.commitTransaction()\n  }\n\n  async rollbackTransaction(conn: DOConnection): Promise<void> {\n    return await conn.rollbackTransaction()\n  }\n\n  async releaseConnection(_conn: DOConnection): Promise<void> {}\n\n  async destroy(): Promise<void> {}\n}\n\nclass DOConnection implements DatabaseConnection {\n  #config: DODialectConfig\n  //   #transactionClient?: DOConnection\n\n  constructor(config: DODialectConfig) {\n    this.#config = config\n  }\n\n  async executeQuery<O>(compiledQuery: CompiledQuery): Promise<QueryResult<O>> {\n    // Transactions are not supported yet.\n    // if (this.#transactionClient) return this.#transactionClient.executeQuery(compiledQuery)\n\n    const cursor = this.#config.ctx.storage.sql.exec(compiledQuery.sql, ...compiledQuery.parameters)\n\n    // Convert cursor to array for results\n    const rows = cursor.toArray() as O[]\n\n    // Get the number of affected rows from the cursor\n    const numAffectedRows = cursor.rowsWritten > 0 ? BigInt(cursor.rowsWritten) : undefined\n\n    return {\n      insertId: undefined, // Durable Objects doesn't provide last_row_id like D1\n      rows: rows || [],\n      numAffectedRows,\n    }\n  }\n\n  async beginTransaction() {\n    // this.#transactionClient = this.#transactionClient ?? new PlanetScaleConnection(this.#config)\n    // this.#transactionClient.#conn.execute('BEGIN')\n    throw new Error('Transactions are not supported yet.')\n  }\n\n  async commitTransaction() {\n    // if (!this.#transactionClient) throw new Error('No transaction to commit')\n    // this.#transactionClient.#conn.execute('COMMIT')\n    // this.#transactionClient = undefined\n    throw new Error('Transactions are not supported yet.')\n  }\n\n  async rollbackTransaction() {\n    // if (!this.#transactionClient) throw new Error('No transaction to rollback')\n    // this.#transactionClient.#conn.execute('ROLLBACK')\n    // this.#transactionClient = undefined\n    throw new Error('Transactions are not supported yet.')\n  }\n\n  async *streamQuery<O>(_compiledQuery: CompiledQuery, _chunkSize: number): AsyncIterableIterator<QueryResult<O>> {\n    throw new Error('DO Driver does not support streaming')\n  }\n}\n"],"mappings":";AAAA;AAAA,EAGE;AAAA,EACA;AAAA,EACA;AAAA,OAOK;AAsBA,IAAM,YAAN,MAAmC;AAAA,EACxC;AAAA,EAEA,YAAY,QAAyB;AACnC,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,gBAAgB;AACd,WAAO,IAAI,cAAc;AAAA,EAC3B;AAAA,EAEA,eAAuB;AACrB,WAAO,IAAI,SAAS,KAAK,OAAO;AAAA,EAClC;AAAA,EAEA,sBAAqC;AACnC,WAAO,IAAI,oBAAoB;AAAA,EACjC;AAAA,EAEA,mBAAmB,IAAuC;AACxD,WAAO,IAAI,mBAAmB,EAAE;AAAA,EAClC;AACF;AAEA,IAAM,WAAN,MAAiC;AAAA,EAC/B;AAAA,EAEA,YAAY,QAAyB;AACnC,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,MAAM,OAAsB;AAAA,EAAC;AAAA,EAE7B,MAAM,oBAAiD;AACrD,WAAO,IAAI,aAAa,KAAK,OAAO;AAAA,EACtC;AAAA,EAEA,MAAM,iBAAiB,MAAmC;AACxD,WAAO,MAAM,KAAK,iBAAiB;AAAA,EACrC;AAAA,EAEA,MAAM,kBAAkB,MAAmC;AACzD,WAAO,MAAM,KAAK,kBAAkB;AAAA,EACtC;AAAA,EAEA,MAAM,oBAAoB,MAAmC;AAC3D,WAAO,MAAM,KAAK,oBAAoB;AAAA,EACxC;AAAA,EAEA,MAAM,kBAAkB,OAAoC;AAAA,EAAC;AAAA,EAE7D,MAAM,UAAyB;AAAA,EAAC;AAClC;AAEA,IAAM,eAAN,MAAiD;AAAA,EAC/C;AAAA;AAAA,EAGA,YAAY,QAAyB;AACnC,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,MAAM,aAAgB,eAAuD;AAI3E,UAAM,SAAS,KAAK,QAAQ,IAAI,QAAQ,IAAI,KAAK,cAAc,KAAK,GAAG,cAAc,UAAU;AAG/F,UAAM,OAAO,OAAO,QAAQ;AAG5B,UAAM,kBAAkB,OAAO,cAAc,IAAI,OAAO,OAAO,WAAW,IAAI;AAE9E,WAAO;AAAA,MACL,UAAU;AAAA;AAAA,MACV,MAAM,QAAQ,CAAC;AAAA,MACf;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAM,mBAAmB;AAGvB,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACvD;AAAA,EAEA,MAAM,oBAAoB;AAIxB,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACvD;AAAA,EAEA,MAAM,sBAAsB;AAI1B,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACvD;AAAA,EAEA,OAAO,YAAe,gBAA+B,YAA2D;AAC9G,UAAM,IAAI,MAAM,sCAAsC;AAAA,EACxD;AACF;","names":[]}